services:
  # MQTT Broker (using Eclipse Mosquitto for demo)
  mqtt:
    image: eclipse-mosquitto:2.0
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - fl-demo

  # Model Server (MQTT-based)
  model-server:
    build:
      context: ./model-server
      dockerfile: Dockerfile
    depends_on:
      - mqtt
    volumes:
      - fl-models:/tmp/fl-models
    environment:
      - MODELS_DIR=/tmp/fl-models
      - MQTT_BROKER=tcp://mqtt:1883
    networks:
      - fl-demo

  # FML Coordinator
  coordinator:
    build:
      context: ./coordinator
      dockerfile: Dockerfile
    depends_on:
      - mqtt
      - model-server
    environment:
      - MQTT_BROKER=tcp://mqtt:1883
      - MODELS_DIR=/tmp/fl-models
    networks:
      - fl-demo
    volumes:
      - fl-models:/tmp/fl-models

  # Propeller Manager
  manager:
    image: ghcr.io/absmach/propeller/manager:latest
    depends_on:
      - mqtt
    ports:
      - "7070:7070"
    environment:
      - MANAGER_DOMAIN_ID=demo
      - MANAGER_CHANNEL_ID=fl
      - MANAGER_CLIENT_ID=manager
      - MANAGER_CLIENT_KEY=manager-key
      - MANAGER_MQTT_ADDRESS=tcp://mqtt:1883
      - MANAGER_HTTP_HOST=0.0.0.0
    networks:
      - fl-demo
    # Note: In production, you'd configure proper storage backends

  # Propeller Proplet (example worker)
  proplet-1:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.proplet
    depends_on:
      - mqtt
      - manager
    environment:
      - PROPLET_DOMAIN_ID=demo
      - PROPLET_CHANNEL_ID=fl
      - PROPLET_CLIENT_ID=proplet-1
      - PROPLET_CLIENT_KEY=proplet-1-key
      - PROPLET_MQTT_ADDRESS=tcp://mqtt:1883
      - PROPLET_EXTERNAL_WASM_RUNTIME=/usr/local/bin/wasmtime
    networks:
      - fl-demo
    healthcheck:
      disable: true

  proplet-2:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.proplet
    depends_on:
      - mqtt
      - manager
    environment:
      - PROPLET_DOMAIN_ID=demo
      - PROPLET_CHANNEL_ID=fl
      - PROPLET_CLIENT_ID=proplet-2
      - PROPLET_CLIENT_KEY=proplet-2-key
      - PROPLET_MQTT_ADDRESS=tcp://mqtt:1883
      - PROPLET_EXTERNAL_WASM_RUNTIME=/usr/local/bin/wasmtime
    networks:
      - fl-demo
    healthcheck:
      disable: true

  proplet-3:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.proplet
    depends_on:
      - mqtt
      - manager
    environment:
      - PROPLET_DOMAIN_ID=demo
      - PROPLET_CHANNEL_ID=fl
      - PROPLET_CLIENT_ID=proplet-3
      - PROPLET_CLIENT_KEY=proplet-3-key
      - PROPLET_MQTT_ADDRESS=tcp://mqtt:1883
      - PROPLET_EXTERNAL_WASM_RUNTIME=/usr/local/bin/wasmtime
    networks:
      - fl-demo
    healthcheck:
      disable: true

volumes:
  fl-models:

networks:
  fl-demo:
    driver: bridge
